---
date: "2021-02-20"
title: "Making an interactive, responsive d3 chart in Gatsby"
summary: ""
lang: "en"
show: false
categories:
    - Data Visualization
    - TypeScript
    - Gatsby
---

import PoissonPlot from './chart'

<Heading aria-label="Jump to title" as="h1" hash="MakingAResponsiveChart">Making an interactive, responsive d3 chart in Gatsby</Heading>

In this blogpost, we will construct the following chart using React components. This is the plot of the probability mass function of a Poisson distribution, leaving the user with the ability to change the mean parameter $\lambda$. It assumes some knowledge of JavaScript/TypeScript, Gatsby and d3.

<PoissonPlot mean={15.0}></PoissonPlot>

This chart is interactive and responsive. It dynamically adapts its width to be around 4/5s of the screen with a certain maximum width and height. Feel free to test it by changing the width of your navigator.

I built it using [d3, a JavaScript library for making data visualizations](https://d3js.org/). To adapt it to my blog and its [Gatsby](https://www.gatsbyjs.com/) set-up, I had to learn a bit of [React](https://reactjs.org/) in the process. This blogpost explains the process from the ground-up. I didn't know anything about React before I started making this post, so I expect it to be friendly to people that have some experience with basic JavaScript (or with programming in general),  with blog developing in Gatsby and with making simple plots on d3.

This interactive plot may seem like a simple example, but it could simply be replaced with more elaborate interactive plots (like the ones showcased in [d3 examples](https://observablehq.com/@d3/gallery)).

<Heading aria-label="React components" as="h2" hash="WhatAreReactComponents">The chart as a React component in mdx</Heading>

Gatsby is built on top of React, which is an open-source library for building user interfaces. React uses reusable components that swallow information in the form of their `props`. The plot showed above is a React component.

When using Gatsby, it is very common to write blogposts in **Markdown React** (or `.mdx`). This is a special version of Markdown that allows us to use React components, and this blogpost is an example of one (see the sourcefile [here]()). So, we will write our plot as a React component in a `chart.tsx` file, and place it in the same folder as we have ths blogpost. That way we can import it by just saying

```tsx
// blogpost.mdx
import PoissonPlot from './chart'

// ... the rest of your blogpost

// The place you want the plot to be
<PoissonPlot mean={15.0}></PoissonPlot>

// ... the rest of your blogpost

```

Now, we need to create and export the React component `PoissonPlot` in `./chart.tsx`. This is the way it looks like at the beginning.

```ts
// chart.tsx, in the same folder as blogpost.mdx
import React, { Component } from 'react'
import * as d3 from 'd3'

interface FigureProps {
  mean: number 
}

interface Point {
  x: number,
  y: number
}

interface State {
  mean: number
  figureWidth: number
  figureHeight: number
}

class PoissonPlot extends Component {
  myRef: React.RefObject<any>;
  data: Array<Point>;
  x: d3.ScaleLinear<number, number, never>;
  y: d3.ScaleLinear<number, number, never>;
  state: State;

  constructor(props: FigureProps) {
      super(props)
      // ...
  }
}

export default PoissonPlot;

```

The `PoissonPlot` component maintains a React reference (and I don't really know what that is), the data as an array of `Points`, two d3 linear axes `x` and `y` and a React `state` with dynamic `mean`, `figureHeight` and `figureWidth`.

<Heading aria-label="React components" as="h2" hash="MakingThePlot">Making the plot</Heading>

Let's plot our probability mass function
$$
y(x;\lambda) = \exp(-\lambda)\frac{\lambda^x}{x!}
$$
for $\lambda=15$ using d3 and React. If we want to make a static plot, we can...

<Heading aria-label="React components" as="h3" hash="SomeFunctionUtilities">Some math utilities</Heading>

We can start by implementing some functions inside our `chart.tsx` that allow us to compute the probability mass function (pmf) of the Poisson, and the cloud of points for $x\in\{1, 2,\dots, 25
\}$.

```tsx
// Somewhere in chart.tsx

function factorial(k: number) {
    // I hadn't manually implemented a factorial since 2013.
  let res = 1;
  for (let i = 1; i <= k; i++) {
      res *= i;
  }
  return res
}

function poissonPMF(k: number, mean: number) {
    return (
        Math.exp(-mean) * Math.pow(mean, k) / factorial(k)
  )
}

function getPoissonPoints(maxX: number, mean: number): Array<Point> {
    return d3.range(maxX).map((k) => ({x: k, y: poissonPMF(k, mean)}))
}

```

<Heading aria-label="React components" as="h2" hash="MakingItInteractive">Making it interactive</Heading>

We want our chart to maintain the mean, and to re-compute the $(x,y)$ points where 
everytime the user modifies the mean $\lambda$.





Now, let's define the default values of our state inside the constructor of the component. We can't access the `window` object of JavaScript in Gatsby, because it also needs to work inside Node.js. So, to get the current

<Heading aria-label="React components" as="h2" hash="MakingItResponsive">Making it Responsive</Heading>

